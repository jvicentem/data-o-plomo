---
title: "Data_O_Plomo_AWS"
author: "Data O Plomo"
date: "8 de abril de 2017"
output: html_document
---

---
title: "DATATON URJC 2017"
author: "Data O Plomo"
date: "7 de abril de 2017"
output: html_document
---

```{r import-libraries, message=FALSE, warning=FALSE}
library(magrittr)
library(RDIDQ)
library(StatMeasures)
library(datacheck)
library(knitr)
library(reshape2)
library(tidyverse)
library(caret)
library(corrplot)
library(doMC)
library(DMwR)
library(kernlab)
library(e1071)
```

#Limpiamos los datos

```{r, echo=FALSE, include=FALSE,}
df.train <- read.csv('./traindata.csv', na.strings = NA)
df.test <- read.csv('./testdata.csv', na.strings = c("NaN"))
```

```{r, echo=FALSE, include=FALSE,}
clean_data <- function(df, test) {
  ano <- as.factor(ifelse(df$Ano==1,"2005",
                                   ifelse(df$Ano==2,"2006",
                                          ifelse(df$Ano==3,"2007",
                                                 ifelse(df$Ano==4,"2008",
                                                        ifelse(df$Ano==5,"2009", "2010"
                                                        )
                                                 )
                                          )
                                   )
                          )
                  )
  
  table(ano)
  
  ano <- relevel(ano, ref = "2007")
  df$Ano <- ano
  
  ###################################################################################################################
  
  provincia <- as.factor(ifelse(df$Provincia==1, "Alicante", 
                                ifelse(df$Provincia==2, "Castellon", "Valencia")))
  
  table(provincia)
  
  provincia <- relevel(provincia, ref = "Valencia")
  df$Provincia <- provincia
  
  ###################################################################################################################
  
  dia_semana <- as.factor(ifelse(df$Dia_Semana==1, "Lunes", 
                            ifelse(df$Dia_Semana==2, "Martes", 
                                   ifelse(df$Dia_Semana==3, "Miercoles", 
                                          ifelse(df$Dia_Semana==4, "Jueves", 
                                                 ifelse(df$Dia_Semana==5, "Viernes", 
                                                        ifelse(df$Dia_Semana==6, "Sabado", 
                                                               ifelse(df$Dia_Semana==7, "Domingo", NA)
                                                               )
                                                        )
                                                 )
                                          )
                                   )
                            )
                    )
  
  
  dia_semana <- relevel(dia_semana, ref = "Domingo")
  df$Dia_Semana <- dia_semana
  
  ###################################################################################################################
  
  tipo_dia <- as.factor(ifelse(df$Tipo_Dia == 1, "Laborable", ifelse(df$Tipo_Dia == 2, "Vispera Festivo", ifelse(df$Tipo_Dia == 3, "Festivo", ifelse(df$Tipo_Dia == 4, "Puente", NA)))))
  
  
  tipo_dia <- relevel(tipo_dia, ref = "Laborable")
  df$Tipo_Dia <- tipo_dia
  
  ###################################################################################################################
  
  aceras <- as.factor(ifelse(df$Aceras == 1, "Si", ifelse(df$Aceras == 2,"No", NA)))
  
  
  aceras <- relevel(aceras, ref = "Si")
  df$Aceras <- aceras
  
  ###################################################################################################################
  
  alcohol_drogas <- as.factor(ifelse(df$Alcohol_Drogas == 1, "Si", ifelse(df$Alcohol_Drogas == 2,"No", NA)))
  
  table(alcohol_drogas)
  
  alcohol_drogas <- relevel(alcohol_drogas, ref = "Si")
  df$Alcohol_Drogas <- alcohol_drogas
  
  ###################################################################################################################
  
  anchura_calzada <- as.factor(ifelse(df$Anchura_Calzada==1, "menor_6", 
                                ifelse(df$Anchura_Calzada==2, "entre_6_y_7", ifelse(df$Anchura_Calzada==3, "mayor_7", NA))))
  
  table(anchura_calzada)
  
  anchura_calzada <- relevel(anchura_calzada, ref = "mayor_7")
  df$Anchura_Calzada <- anchura_calzada
  
  ###################################################################################################################
  
  anchura_carril <- as.factor(ifelse(df$Anchura_Carril==1, "mayor_3.75", 
                                      ifelse(df$Anchura_Carril==2, "entre_3.25_y_3.75", ifelse(df$Anchura_Carril==3, "menor_3.25", NA))))
  
  table(anchura_carril)
  
  anchura_carril <- relevel(anchura_carril, ref = "entre_3.25_y_3.75")
  df$Anchura_Carril <- anchura_carril
  
  ###################################################################################################################
  
  arcen <- as.factor(ifelse(df$Arcen==1, "Inexistente", 
                                     ifelse(df$Arcen==2, "menor_1.5", 
                                            ifelse(df$Arcen==3, "entre_1.5_y_2.5", 
                                                   ifelse(df$Arcen==4, "mayor_2.5", 
                                                          ifelse(df$Arcen==5, "mayor_2.5", NA))
                                                   )
                                            )
                            )
                     )
  
  table(arcen)
  
  arcen <- relevel(arcen, ref = "entre_1.5_y_2.5")
  df$Arcen <- arcen
  
  ###################################################################################################################
  
  arcen_pavimentado <- as.factor(ifelse(df$Arcen_Pavimentado == 1, "Si", ifelse(df$Arcen_Pavimentado == 2, "No", NA)))
  
  table(arcen_pavimentado)
  
  arcen_pavimentado <- relevel(arcen_pavimentado, ref = "No")
  df$Arcen_Pavimentado <- arcen_pavimentado
  
  ###################################################################################################################
  
  averia_mecanica <- as.factor(ifelse(df$Averia_Mecanica == 1, "Si", ifelse(df$Averia_Mecanica == 2,"No", NA)))
  
  table(averia_mecanica)
  
  averia_mecanica <- relevel(averia_mecanica, ref = "Si")
  df$Averia_Mecanica <- averia_mecanica
  
  ###################################################################################################################
  
  barrera_seguridad <- as.factor(ifelse(df$Barrera_Seguridad == 1, "Si", ifelse(df$Barrera_Seguridad == 2, "No", NA)))
  
  table(barrera_seguridad)
  
  barrera_seguridad <- relevel(barrera_seguridad, ref = "Si")
  df$Barrera_Seguridad <- barrera_seguridad
  
  ###################################################################################################################
  
  cansancio_sueno <- as.factor(ifelse(df$Cansancio_Sueno == 1, "Si", ifelse(df$Cansancio_Sueno == 2, "No", NA)))
  
  table(cansancio_sueno)
  
  cansancio_sueno <- relevel(cansancio_sueno, ref = "Si")
  df$Cansancio_Sueno <- cansancio_sueno
  
  ###################################################################################################################
  
  
  captafaros <- as.factor(ifelse(df$Captafaros == 1, "Si", ifelse(df$Captafaros == 2,"No", NA)))
  
  table(captafaros)
  
  captafaros <- relevel(captafaros, ref = "Si")
  df$Captafaros <- captafaros
  
  ###################################################################################################################
  
  circulacion <- as.factor(ifelse(df$Circulacion==1, "Fluida", 
                                      ifelse(df$Circulacion==2, "Densa", ifelse(df$Circulacion==3,"Congestionada", NA))))
  
  table(circulacion)
  
  circulacion <- relevel(circulacion, ref = "Fluida")
  df$Circulacion <- circulacion
  
  ###################################################################################################################
  
  circulacion_medidas_especiales <- as.factor(ifelse(df$Circulacion_Medidas_Especiales == 1, "Carril reversible", 
                                                     ifelse(df$Circulacion_Medidas_Especiales == 2, "Habilitacion arcen", 
                                                            ifelse(df$Circulacion_Medidas_Especiales == 3, "Otra medida", 
                                                                   ifelse(df$Circulacion_Medidas_Especiales == 4,"Ninguna medida", NA)))))
  
  table(circulacion_medidas_especiales)
  
  circulacion_medidas_especiales <- relevel(circulacion_medidas_especiales, ref = "Ninguna medida")
  df$Circulacion_Medidas_Especiales <- circulacion_medidas_especiales
  
  ###################################################################################################################
  
  circular_sentido_contrario <- as.factor(ifelse(df$Circular_Sentido_Contrario == 1, "Si", ifelse(df$Circular_Sentido_Contrario == 2,"No", NA)))
  
  table(circular_sentido_contrario)
  
  circular_sentido_contrario <- relevel(circular_sentido_contrario, ref = "Si")
  df$Circular_Sentido_Contrario <- circular_sentido_contrario
  
  ###################################################################################################################
  
  distraccion <- as.factor(ifelse(df$Distraccion == 1, "Si", ifelse(df$Distraccion == 2,"No", NA)))
  
  table(distraccion)
  
  distraccion <- relevel(distraccion, ref = "Si")
  df$Distraccion <- distraccion
  
  ###################################################################################################################
  
  enfermedad <- as.factor(ifelse(df$Enfermedad == 2, "Si", ifelse(df$Enfermedad == 1, "No", NA)))
  
  table(enfermedad)
  
  enfermedad <- relevel(enfermedad, ref = "Si")
  df$Enfermedad <- enfermedad
  
  ###################################################################################################################
  
  estado_condicion_senalizacion <- as.factor(ifelse(df$Estado_Condicion_Senalizacion == 1, "Si", ifelse(df$Estado_Condicion_Senalizacion == 2,"No", NA)))
  
  table(estado_condicion_senalizacion)
  
  estado_condicion_senalizacion <- relevel(estado_condicion_senalizacion, ref = "Si")
  df$Estado_Condicion_Senalizacion <- estado_condicion_senalizacion
  
  ###################################################################################################################
  
  estado_condicion_via <- as.factor(ifelse(df$Estado_Condicion_Via == 1, "Si", ifelse(df$Estado_Condicion_Via == 2,"No", NA)))
  
  table(estado_condicion_via)
  
  estado_condicion_via <- relevel(estado_condicion_via, ref = "Si")
  df$Estado_Condicion_Via <- estado_condicion_via
  
  ###################################################################################################################
  
  factores_atmosfericos <- as.factor(ifelse(df$Factores_Atmosfericos == 1, "Buen tiempo", 
                                            ifelse(df$Factores_Atmosfericos == 2, "Niebla intensa",
                                                   ifelse(df$Factores_Atmosfericos == 3, "Niebla ligera",
                                                          ifelse(df$Factores_Atmosfericos == 4, "Lloviznando",
                                                                 ifelse(df$Factores_Atmosfericos == 5, "Lluvia fuerte",
                                                                        ifelse(df$Factores_Atmosfericos == 6, "Granizando",
                                                                               ifelse(df$Factores_Atmosfericos == 7, "Nevado",
                                                                                      ifelse(df$Factores_Atmosfericos == 8, "Viento fuerte", 
                                                                                             ifelse(df$Factores_Atmosfericos == 9, "Otro", NA))))))))))
  
  table(factores_atmosfericos)
  
  factores_atmosfericos <- relevel(factores_atmosfericos, ref = "Buen tiempo")
  df$Factores_Atmosfericos <- factores_atmosfericos
  
  ###################################################################################################################
  
  fuera_o_interseccion <- as.factor(ifelse(df$Fuera_o_Interseccion == 1, "Recta", 
                                           ifelse(df$Fuera_o_Interseccion == 2, "Curva suave",
                                                  ifelse(df$Fuera_o_Interseccion == 3, "Curva fuerte sin senal",
                                                         ifelse(df$Fuera_o_Interseccion == 4, "Curva fuerte con senal y sin senal velocidad",
                                                                ifelse(df$Fuera_o_Interseccion == 5, "Curva fuerte con senal y con senal velocidad",
                                                                       ifelse(df$Fuera_o_Interseccion == 6, "Interseccion con carretera",
                                                                              ifelse(df$Fuera_o_Interseccion == 7, "Interseccion con calle", NA)
                                                                                            )
                                                                                     )
                                                                              )
                                                                       )
                                                                )
                                                         )
                                                  )
                                    
  table(fuera_o_interseccion)
  
  fuera_o_interseccion <- relevel(fuera_o_interseccion, ref = "Recta")
  df$Fuera_o_Interseccion <- fuera_o_interseccion
  
  ###################################################################################################################
  
  #anchura_calzada <- as.factor(ifelse(df$Anchura_Calzada == 1, "Si", ifelse(df$Anchura_Calzada == 2, "No", NA)))
  
  #table(anchura_calzada)
  
  #anchura_calzada <- relevel(anchura_calzada, ref = "Si")
  #df$Anchura_Calzada<- anchura_calzada
  
  ###################################################################################################################
  
  inexperiencia_conductor <- as.factor(ifelse(df$Inexperiencia_Conductor == 1, "Si", ifelse(df$Inexperiencia_Conductor == 2,"No", NA)))
  
  table(inexperiencia_conductor)
  
  inexperiencia_conductor<- relevel(inexperiencia_conductor, ref = "Si")
  df$Inexperiencia_Conductor <- inexperiencia_conductor
  
  ###################################################################################################################
  
  infraccion_norma_circulacion <- as.factor(ifelse(df$Infraccion_Norma_Circulacion == 1, "Si", ifelse(df$Infraccion_Norma_Circulacion == 2,"No", NA)))
  
  table(infraccion_norma_circulacion)
  
  infraccion_norma_circulacion <- relevel(infraccion_norma_circulacion, ref = "Si")
  df$Infraccion_Norma_Circulacion <- infraccion_norma_circulacion
  
  ###################################################################################################################
  
  interseccion_acondicionamiento <- as.factor(ifelse(df$Interseccion_Acondicionamiento == 1, "Nada especial", 
                                           ifelse(df$Interseccion_Acondicionamiento == 2, "Solo isletas o paso para peatones en via secundaria",
                                                  ifelse(df$Interseccion_Acondicionamiento == 3, "Paso para peatones o isleta en centro de via principal",
                                                         ifelse(df$Interseccion_Acondicionamiento == 4, "Carril central de espera",
                                                                ifelse(df$Interseccion_Acondicionamiento == 5, "Senal de giro izquiera",
                                                                       ifelse(df$Interseccion_Acondicionamiento == 6, "Otro tipo",
                                                                              ifelse(df$Interseccion_Acondicionamiento == 7, "No interseccion", NA)
                                                                       )
                                                                )
                                                         )
                                                  )
                                           )
  )
  )
  
  table(interseccion_acondicionamiento)
  
  interseccion_acondicionamiento <- relevel(interseccion_acondicionamiento, ref = "No interseccion")
  df$Interseccion_Acondicionamiento <- interseccion_acondicionamiento
  
  ###################################################################################################################
  
  interseccion_tipo <- as.factor(ifelse(df$Interseccion_Tipo == 1, "En T o Y", 
                                                     ifelse(df$Interseccion_Tipo == 2, "En X o -",
                                                            ifelse(df$Interseccion_Tipo == 3, "Enlace de entrada",
                                                                   ifelse(df$Interseccion_Tipo == 4, "Enlace de salida",
                                                                          ifelse(df$Interseccion_Tipo == 5, "Giratoria",
                                                                                 ifelse(df$Interseccion_Tipo == 6, "Otros",
                                                                                        ifelse(df$Interseccion_Tipo == 7, "No interseccion", NA)
                                                                                 )
                                                                          )
                                                                   )
                                                            )
                                                     )
  )
  )
  
  table(interseccion_tipo)
  
  interseccion_tipo <- relevel(interseccion_tipo, ref = "No interseccion")
  df$Interseccion_Tipo <- interseccion_tipo
  
  ###################################################################################################################
  
  luminosidad <- as.factor(ifelse(df$Luminosidad==1, "Pleno dia", 
                            ifelse(df$Luminosidad==2, "Crepusculo", 
                                   ifelse(df$Luminosidad==3, "Suficiente", 
                                          ifelse(df$Luminosidad==4, "Insuficiente", 
                                                 ifelse(df$Luminosidad==5, "Sin iluminacion", NA))
                                   )
                            )
  )
  )
  
  table(luminosidad)
  
  luminosidad <- relevel(luminosidad, ref = "Pleno dia")
  df$Luminosidad <- luminosidad
  
  ###################################################################################################################
  
  mal_estado_vehiculo <- as.factor(ifelse(df$Mal_Estado_Vehiculo == 1, "Si", ifelse(df$Mal_Estado_Vehiculo == 2,"No", NA)))
  
  table(mal_estado_vehiculo)
  
  mal_estado_vehiculo <- relevel(mal_estado_vehiculo, ref = "Si")
  df$Mal_Estado_Vehiculo <- mal_estado_vehiculo
  
  ###################################################################################################################
  
  marcas_viales <- as.factor(ifelse(df$Marcas_Viales==1, "Inexistentes", 
                                  ifelse(df$Marcas_Viales==2, "Solo separacion carriles", 
                                         ifelse(df$Marcas_Viales==3, "Separacion carriles y bordes", 
                                                ifelse(df$Marcas_Viales==4, "Solo separacion bordes", NA)
                                                )
                                         )
                                  )
  )
  
  
  table(marcas_viales)
  
  marcas_viales <- relevel(marcas_viales, ref = "Separacion carriles y bordes")
  df$Marcas_Viales <- marcas_viales
  
  ###################################################################################################################
  
  mediana <- as.factor(ifelse(df$Mediana == 1, "Si", ifelse(df$Mediana == 2,"No", NA)))
  
  table(mediana)
  
  mediana <- relevel(mediana, ref = "Si")
  df$Mediana <- mediana
  
  ###################################################################################################################
  
  meteorologia_adversa <- as.factor(ifelse(df$Meteorologia_Adversa == 1, "Si", ifelse(df$Meteorologia_Adversa == 2,"No", NA)))
  
  table(meteorologia_adversa)
  
  meteorologia_adversa <- relevel(meteorologia_adversa, ref = "Si")
  df$Meteorologia_Adversa <- meteorologia_adversa
  
  ###################################################################################################################
  
  # otras_circunstancias <- as.factor(ifelse(df$Otras_Circunstancias == 1, "Paso a nivel", 
  #                                       ifelse(df$Otras_Circunstancias == 2, "Estrechamiento",
  #                                              ifelse(df$Otras_Circunstancias == 3, "Camino de rasante",
  #                                                     ifelse(df$Otras_Circunstancias == 4, "Fuerte descenso",
  #                                                            ifelse(df$Otras_Circunstancias == 5, "Tramo deslizante senalizado",
  #                                                                   ifelse(df$Otras_Circunstancias == 6, "Baden",
  #                                                                          ifelse(df$Otras_Circunstancias == 7, "Escalon", 
  #                                                                                 ifelse(df$Otras_Circunstancias == 8, "Obras", 
  #                                                                                        ifelse(df$Otras_Circunstancias == 9, "Baches",
  #                                                                                               ifelse(df$Otras_Circunstancias == 10, "Inundacion",
  #                                                                                                      ifelse(df$Otras_Circunstancias == 11, "Peralte invertido",
  #                                                                                                             ifelse(df$Otras_Circunstancias == 12, "Fin carril lento",
  #                                                                                                                    ifelse(df$Otras_Circunstancias == 13, "Otra",
  #                                                                                                                           ifelse(df$Otras_Circunstancias == 14, "Ninguna", NA)
  #                                                                   )
  #                                                            )
  #                                                     )
  #                                              )
  #                                       )
  # )
  # )
  # )
  # )
  # )
  # )
  # )
  # )
  # )
  # 
  # table(otras_circunstancias)
  # 
  # otras_circunstancias <- relevel(otras_circunstancias, ref = "Ninguna")
  # df$Otras_Circunstancias <- otras_circunstancias
  
  ###################################################################################################################
  
  otro_factor <- as.factor(ifelse(df$Otro_Factor == 1, "Si", ifelse(df$Otro_Factor == 2,"No", NA)))
  
  table(otro_factor)
  
  otro_factor <- relevel(otro_factor, ref = "Si")
  df$Otro_Factor <- otro_factor
  
  ###################################################################################################################
  
  paneles_direccionales <- as.factor(ifelse(df$Paneles_Direccionales == 1, "Si", ifelse(df$Paneles_Direccionales == 2,"No", NA)))
  
  table(paneles_direccionales)
  
  paneles_direccionales <- relevel(paneles_direccionales, ref = "Si")
  df$Paneles_Direccionales <- paneles_direccionales
  
  ###################################################################################################################
  
  prioridad_regulara_por <- as.factor(ifelse(df$Prioridad_Regulada_por == 1, "Agente", 
                                        ifelse(df$Prioridad_Regulada_por == 2, "Semaforo",
                                               ifelse(df$Prioridad_Regulada_por == 3, "Senal STOP",
                                                      ifelse(df$Prioridad_Regulada_por == 4, "Senal ceda el paso",
                                                             ifelse(df$Prioridad_Regulada_por == 5, "Solo marcas viales",
                                                                    ifelse(df$Prioridad_Regulada_por == 6, "Paso peatones",
                                                                           ifelse(df$Prioridad_Regulada_por == 7, "Otra senal", 
                                                                                  ifelse(df$Prioridad_Regulada_por == 8, "Ninguna",NA)
                                                                    )
                                                             )
                                                      )
                                               )
                                        )
                                        )
  )
  )
  
  table(prioridad_regulara_por)
  
  prioridad_regulara_por <- relevel(prioridad_regulara_por, ref = "Ninguna")
  df$Prioridad_Regulada_por <- prioridad_regulara_por
  
  ###################################################################################################################
  
  senalizacion_peligro <- as.factor(ifelse(df$Senalizacion_Peligro==1, "Existente", 
                                    ifelse(df$Senalizacion_Peligro==2, "Inexistente", 
                                           ifelse(df$Senalizacion_Peligro==3, "Innecesaria", NA)
                                           )
                                    )
  )
  
  
  table(senalizacion_peligro)
  
  senalizacion_peligro <- relevel(senalizacion_peligro, ref = "Existente")
  df$Senalizacion_Peligro <- senalizacion_peligro
  
  ###################################################################################################################
  
  sentido <- as.factor(ifelse(df$Sentido == 0, "Ascendente", ifelse(df$Sentido == 1,"Descendente", NA)))
  
  table(sentido)
  
  df$Sentido <- sentido
  
  ###################################################################################################################
  
  sin_opinion_definida <- as.factor(ifelse(df$Sin_Opinion_Definida == 1, "Si", ifelse(df$Sin_Opinion_Definida == 2,"No", NA)))
  
  table(sin_opinion_definida)
  
  sin_opinion_definida <- relevel(sin_opinion_definida, ref = "Si")
  df$Sin_Opinion_Definida <- sin_opinion_definida
  
  ###################################################################################################################
  
  
  superficie <- as.factor(ifelse(df$Superficie == 1, "Seca y limpia", 
                                            ifelse(df$Superficie == 2, "Umbria",
                                                   ifelse(df$Superficie == 3, "Mojada",
                                                          ifelse(df$Superficie == 4, "Helada",
                                                                 ifelse(df$Superficie == 5, "Nevada",
                                                                        ifelse(df$Superficie == 6, "Barrillo",
                                                                               ifelse(df$Superficie == 7, "Gravilla suelta",
                                                                                      ifelse(df$Superficie == 8, "Aceite", 
                                                                                             ifelse(df$Superficie == 9, "Otro", NA))))))))))
  
  table(superficie)
  
  superficie <- relevel(superficie, ref = "Seca y limpia")
  df$Superficie <- superficie
  
  ###################################################################################################################
  
  tipo_via <- as.factor(ifelse(df$Tipo_Via == 1, "Autopista", 
                                 ifelse(df$Tipo_Via == 2, "Autovia",
                                        ifelse(df$Tipo_Via == 3, "Via rapida",
                                               ifelse(df$Tipo_Via == 4, "Via convencional con carril lento",
                                                      ifelse(df$Tipo_Via == 5, "Via convencional sin carril lento", #MIRAR DOCUMENTACION
                                                             ifelse(df$Tipo_Via == 6, "Camino vecinal",
                                                                    ifelse(df$Tipo_Via == 7, "Via de servicio",
                                                                           ifelse(df$Tipo_Via == 8, "Ramal enlace", 
                                                                                  ifelse(df$Tipo_Via == 9, "Otro", NA))))))))))
  
  table(tipo_via)
  
  tipo_via <- relevel(tipo_via, ref = "Via convencional sin carril lento")
  df$Tipo_Via <- tipo_via
  
  ###################################################################################################################
  
  tramo_obras <- as.factor(ifelse(df$Tramo_Obras == 1, "Si", ifelse(df$Tramo_Obras == 2,"No", NA)))
  
  table(tramo_obras)
  
  tramo_obras <- relevel(tramo_obras, ref = "Si")
  df$Tramo_Obras <- tramo_obras
  
  ###################################################################################################################
  
  velocidad_inadecuada <- as.factor(ifelse(df$Velocidad_Inadecuada == 1, "Si", ifelse(df$Velocidad_Inadecuada == 2,"No", NA)))
  
  table(velocidad_inadecuada)
  
  velocidad_inadecuada <- relevel(velocidad_inadecuada, ref = "Si")
  df$Velocidad_Inadecuada <- velocidad_inadecuada
  
  ###################################################################################################################
  
  visibilidad_restringida_por <- as.factor(ifelse(df$Visibilidad_Restringida_por == 1, "Edificios", 
                                             ifelse(df$Visibilidad_Restringida_por == 2, "Terreno",
                                                    ifelse(df$Visibilidad_Restringida_por == 3, "Vegetacion",
                                                           ifelse(df$Visibilidad_Restringida_por == 4, "Factores atmosfericos",
                                                                  ifelse(df$Visibilidad_Restringida_por == 5, "Deslumbramiento",
                                                                         ifelse(df$Visibilidad_Restringida_por == 6, "Polvo/humo",
                                                                                ifelse(df$Visibilidad_Restringida_por == 7, "Otro", 
                                                                                       ifelse(df$Visibilidad_Restringida_por == 8, "Sin restriccion",NA)
                                                                                )
                                                                         )
                                                                  )
                                                           )
                                                    )
                                             )
  )
  )
  
  table(visibilidad_restringida_por)
  
  visibilidad_restringida_por <- relevel(visibilidad_restringida_por, ref = "Terreno")
  df$Visibilidad_Restringida_por <- visibilidad_restringida_por
  
  ###################################################################################################################
  
  visibilidad_senalizacion_vertical <- as.factor(ifelse(df$Visibilidad_Senalizacion_Vertical==1, "Buena", 
                                           ifelse(df$Visibilidad_Senalizacion_Vertical==2, "Deficiente", 
                                                  ifelse(df$Visibilidad_Senalizacion_Vertical==3, "Nula", NA)
                                           )
  )
  )
  
  
  table(visibilidad_senalizacion_vertical)
  
  visibilidad_senalizacion_vertical <- relevel(visibilidad_senalizacion_vertical, ref = "Deficiente")
  df$Visibilidad_Senalizacion_Vertical <- visibilidad_senalizacion_vertical
  
  ###################################################################################################################
  
  zona <- as.factor(ifelse(df$Zona==1, "Carretera", 
                      ifelse(df$Zona==2, "Urbana", 
                        ifelse(df$Zona==3, "Travesia", NA)
                    )
  )
  )
  
  
  table(zona)
  
  zona <- relevel(zona, ref = "Carretera")
  df$Zona <- zona
  
  ###################################################################################################################
  
  hitos_arista <- as.factor(ifelse(df$Hitos_Arista == 1, "Si", ifelse(df$Hitos_Arista == 2,"No", NA)))
  
  table(hitos_arista)
  
  hitos_arista <- relevel(hitos_arista, ref = "Si")
  df$Hitos_Arista <- hitos_arista
  
  ###################################################################################################################
  
  irrupcion_animal <- as.factor(ifelse(df$Irrupcion_Animal == 1, "Si", ifelse(df$Irrupcion_Animal == 2,"No", NA)))
  
  table(irrupcion_animal)
  
  irrupcion_animal <- relevel(irrupcion_animal, ref = "Si")
  df$Irrupcion_Animal <- irrupcion_animal
  
  ###################################################################################################################
  
  if (!test) {
    gravedad <- as.factor(ifelse(df$N_Muertos == 0 & df$N_Graves == 0 & df$N_Leves == 0, 0, 1))
    df$Gravedad <- gravedad    
  }
  
  ###################################################################################################################
  
  timestamp <- df %>% 
    rowwise() %>%
    summarise(datetimes = paste0(Ano,'-',ifelse(Mes < 10, paste0('0',Mes), Mes),'-',ifelse(Dia < 10, paste0('0',Dia), Dia),' ',Hora_Real,':00')) %>%
    select(datetimes) %>%
    purrr::map(., function(x) strptime(x, format="%Y-%m-%d %H:%M")) %>%
    as.data.frame(.)
  
  df$Timestamp <- timestamp  
  
  ###################################################################################################################
  
  df$Hora_Real <- as.factor(ifelse(as.numeric(df$Hora_Real) %in% c(2, 3, 10, 11, 12, 13, 14, 17, 20), "Hora_grave", "Hora_leve"))

#####################################################################################################################

  df$Tipo_Via <- as.factor(ifelse(df$Tipo_Via == "Via convencional sin carril lento", "Conv rapida", ifelse(df$Tipo_Via == "Autovia" | df$Tipo_Via == "Via rapida", "Autovia", "Resto")))
  
  ###################################################################################################################
  
  df$Anchura_Calzada <- as.factor(ifelse(df$Anchura_Calzada == "mayor_7", "mayor_7", "menor_7"))
                                           ###################################################################################################################
  
  df$Anchura_Carril <- as.factor(ifelse(df$Anchura_Carril == "entre_3.25_y_3.75", "Correcta", "NoCorrecta"))
  
  ###################################################################################################################
  
  df$Arcen <- as.factor(ifelse(df$Arcen == "Inexistente" | df$Arcen == "entre_1.5_y_2.5", "TipoB", ifelse(df$Arcen=="mayor_2.5", "TipoC","TipoA")))
  
  ###################################################################################################################
  
  tipo_dia <- as.factor(case_when(
                df$Tipo_Dia %>% is_in(c("Laborable", "Puente")) ~ 'TipoA',
                df$Tipo_Dia %>% is_in(c("Vispera Festivo", "Festivo")) ~ 'TipoB'
  ))
  
  tipo_dia <- relevel(tipo_dia, ref = "TipoA")
  df$Tipo_Dia <- tipo_dia
  
  ###################################################################################################################
  
  df$Interseccion_Tipo <- as.factor(ifelse(df$Interseccion_Tipo == "No interseccion" | df$Interseccion_Tipo == "Enlace de salida", "TipoA", ifelse(df$Interseccion_Tipo == "Enlace de entrada" | df$Interseccion_Tipo == "Giratoria", "TipoB", "TipoC")))  
  
  ###################################################################################################################
  
  df$Superficie <- as.factor(ifelse(df$Superficie == "Seca y limpia" | df$Superficie == "Aceite" | df$Superficie == "Otro" | df$Superficie == "Mojada", "TipoA", ifelse(df$Superficie == "Umbria" | df$Superficie == "Gravilla suelta" | df$Superficie == "Nevada", "TipoB", "TipoC")))
  
  ###################################################################################################################
  
  df$Interseccion_Acondicionamiento <- as.factor(ifelse(df$Interseccion_Acondicionamiento == "Carril central de espera" | df$Interseccion_Acondicionamiento == "Senal de giro izquiera", "TipoA", "TipoB"))
  
  ###################################################################################################################
  
  df$Prioridad_Regulada_por <- as.factor(ifelse(df$Prioridad_Regulada_por == "Ninguna" | df$Prioridad_Regulada_por == "Otra senal" | df$Prioridad_Regulada_por=="Senal ceda el paso" | df$Prioridad_Regulada_por == "Solo marcas viales","TipoA", "TipoB"))
  
  ###################################################################################################################
  
  df$Luminosidad <- as.factor(ifelse(df$Luminosidad == "Pleno dia" | df$Luminosidad == "Sin iluminacion", "TipoA", "TipoB"))
  
  ###################################################################################################################
  
  df$Senalizacion_Peligro <- as.factor(ifelse(df$Senalizacion_Peligro == "Innecesaria", "TipoA",  "TipoB"))
  
  ###################################################################################################################
  
  df$Visibilidad_Senalizacion_Vertical <- as.factor(ifelse(df$Visibilidad_Senalizacion_Vertical == "Deficiente" | df$Visibilidad_Senalizacion_Vertical == "Nula", "TipoA",  "TipoB"))
  
  ###################################################################################################################
  
otras_circunstancias <- as.factor(case_when(
                    df$Otras_Circunstancias %>% is_in(c(1, 11, 9, 3, 7, 4)) ~ 'Grave',
                    df$Otras_Circunstancias %>% is_in(c(14, 8, 13, 5)) ~ 'Neutro',
                    df$Otras_Circunstancias %>% is_in(c(6, 2, 12, 10)) ~ 'NoGrave'
    
))
  
#   paso a nivel + peralte + Baches + Cambio de rasante + Escalon + Fuerte descenso -> Grave
# 	Ninguna + Obras + Otra + Tramo deslizante senalizado -> Neutra
# 	Baden + Estrechamiento + Fin carril lento + Inundacion
  
  table(otras_circunstancias)
  
  otras_circunstancias <- relevel(otras_circunstancias, ref = "Neutro")
  df$Otras_Circunstancias <- otras_circunstancias
  
  ###################################################################################################################
  
    df$Fuera_o_Interseccion <- as.factor(ifelse(df$Fuera_o_Interseccion == "Recta" | df$Fuera_o_Interseccion == "Curva fuerte sin senal" | df$Fuera_o_Interseccion == "Curva suave" | df$Fuera_o_Interseccion == "Interseccion con carretera", "TipoA", "TipoB"))
  
  ###################################################################################################################
  
  df$Tipo_Est <- as.factor(ifelse(df$Tipo_Est == "Cob", "TipoA", "TipoB"))
  
  ###################################################################################################################
  
  df$Arboles <- as.factor(ifelse(df$Arboles == "2", "TipoA", "TipoB"))
  
  ###################################################################################################################
  
  return(df)
}


```

# Guardamos en un csv los datos limpiados
```{r}
df.train <- clean_data(df.train, test=FALSE)
df.test <- clean_data(df.test, test=TRUE)

# write.csv(df.train, "./cleaned_train.csv", row.names = T)
# write.csv(df.test, "./cleaned_test.csv", row.names = T)
```


# Informe de los datos

```{r}
#Este informe mejor para ver las variables con muchos missing
kable(didq_summry(df.train))

# Variables con altos porcentaje de missing:
#--------------------------------------------
# Sentido: 54.5%
# Visibilidad_Restringida_por: 89.54%
# Arboles_Metros_Calzada: 98.76%
# Colision_Vehiculos_Marcha: 54.10%
# Colision_Vehiculo_Obstaculo_1: 97.46%
# Colision_Vehiculo_Obstaculo_2: 97.46%
# Atropello_1: 94.79%
# Atropello_2: 94.79%
# Vuelco_1: 96.23%
# Vuelco_2: 96.23%
# Salida_Sin_Colision: 86.30%
# Salida_Con_Colision: 73.82%
# Lado_Salida: 60.12%
# Otro: 97.28%

xda::numSummary(df.train)
xda::charSummary(df.train)
```

# Miramos si las categóricas son significativas o no
## Anchura calzada

```{r}
tabla <- table(df.train$Anchura_Calzada,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Anchura_Calzada")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Anchura_Calzada", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Anchura_Calzada, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab
```


## Arcen_Pavimentado

```{r}
tabla <- table(df.train$Arcen_Pavimentado,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Arcen_Pavimentado")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Arcen_Pavimentado", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Arcen_Pavimentado, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Arcen_Pavimentado)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por arcen pavimentado y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Arcen_Pavimentado),position= position_dodge(width=10), vjust=-0.2, color="black")
```

## Captafaros

```{r}
tabla <- table(df.train$Captafaros,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Captafaros")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Captafaros", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Captafaros, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Captafaros)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Captafaros y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Captafaros),position= position_dodge(width=10), vjust=-0.2, color="black")
```

## Superficie

```{r}
tabla <- table(df.train$Superficie,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Superficie")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Superficie", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Superficie, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Superficie)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Superficie y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Superficie),position= position_dodge(width=10), vjust=-0.2, color="black")
```

## Luminosidad

```{r}
tabla <- table(df.train$Luminosidad,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Luminosidad")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Luminosidad", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Luminosidad, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Luminosidad)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Luminosidad y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Luminosidad),position= position_dodge(width=10), vjust=-0.2, color="black")
```

## Aceras
```{r}
tabla <- table(df.train$Aceras,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Aceras")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Aceras", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Aceras, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Aceras)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Aceras y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Aceras),position= position_dodge(width=10), vjust=-0.2, color="black")
```

#Visibilidad_Senalizacion_Vertical

```{r}
tabla <- table(df.train$Visibilidad_Senalizacion_Vertical,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Visibilidad_Senalizacion_Vertical")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Visibilidad_Senalizacion_Vertical", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Visibilidad_Senalizacion_Vertical, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Visibilidad_Senalizacion_Vertical)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Visibilidad_Senalizacion_Vertical y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Visibilidad_Senalizacion_Vertical),position= position_dodge(width=10), vjust=-0.2, color="black")
```

#Inexperiencia_Conductor

```{r}
tabla <- table(df.train$Inexperiencia_Conductor,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Inexperiencia_Conductor")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Inexperiencia_Conductor", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Inexperiencia_Conductor, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Inexperiencia_Conductor)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Inexperiencia_Conductor y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Inexperiencia_Conductor),position= position_dodge(width=10), vjust=-0.2, color="black")
```

#Cansancio_Sueno

```{r}
tabla <- table(df.train$Cansancio_Sueno,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Cansancio_Sueno")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Cansancio_Sueno", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Cansancio_Sueno, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Cansancio_Sueno)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Cansancio_Sueno y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Cansancio_Sueno),position= position_dodge(width=10), vjust=-0.2, color="black")
```

#Infraccion_Norma_Circulacion

```{r}
tabla <- table(df.train$Infraccion_Norma_Circulacion,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Infraccion_Norma_Circulacion")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Infraccion_Norma_Circulacion", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Infraccion_Norma_Circulacion, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Infraccion_Norma_Circulacion)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Infraccion_Norma_Circulacion y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Infraccion_Norma_Circulacion),position= position_dodge(width=10), vjust=-0.2, color="black")
```

##Circular_Sentido_Contrario

```{r}
tabla <- table(df.train$Circular_Sentido_Contrario,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Circular_Sentido_Contrario")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Circular_Sentido_Contrario", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Circular_Sentido_Contrario, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Circular_Sentido_Contrario)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Circular_Sentido_Contrario y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Circular_Sentido_Contrario),position= position_dodge(width=10), vjust=-0.2, color="black")
```

##Fuera_o_Interseccion

```{r}
tabla <- table(df.train$Fuera_o_Interseccion,df.train$Gravedad)
mtab <- melt(tabla, id.vars="Fuera_o_Interseccion")
mtab$Var1 <- as.factor(mtab$Var1)
colnames(mtab) <- c("Fuera_o_Interseccion", "Gravedad", "value")
mtab1 <- mtab %>% group_by(Fuera_o_Interseccion, Gravedad) %>%   summarise (n=sum(value)) %>% mutate(freq = round(n / sum(n)*100,2)) %>% arrange(Gravedad)
mtab$freq <- mtab1$freq
mtab

ggplot(mtab, aes(Gravedad,value, fill = Fuera_o_Interseccion)) +
  geom_bar(stat="identity", position="dodge", width = 10 ) +
  facet_wrap(~Gravedad, scales = "free_y")  + scale_y_continuous(name="Número de casos") +   ggtitle("Número de caso por Fuera_o_Interseccion y gravedad") +         
  theme(axis.line=element_blank(),axis.text.x=element_blank(),
        axis.ticks=element_blank(), axis.title.x=element_blank()) + 
  geom_text(aes(x=, y = value*0.75,label = freq,  group = Fuera_o_Interseccion),position= position_dodge(width=10), vjust=-0.2, color="black")
```

# Quitamos variables

```{r}

# Variables eliminadas a mano:
# c("Arboles_Metros_Calzada", "Colision_Vehiculo_Obstaculo_1", "Colision_Vehiculo_Obstaculo_2", "Atropello_1", "Atropello_2", "Vuelco_1", "Vuelco_2", "Salida_Sin_Colision", "Otro", "Visibilidad_Restringida_por", "Colision_Vehiculos_Marcha", "Salida_Con_Colision", "Lado_Salida", "Dia", "Dia_Semana", "Arcen_Pavimentado", "Circulacion", "Circulacion_Medidas_Especiales", "Inexperiencia_Conductor", "Tramo_Obras", "Otro_Factor", "Arboles", "Curvatura", "Peralte", "GPS_x", "GPS_y", "GPS_z", "IMD", "Zona", "Marcas_Viales", "Distraccion", "Hitos_Arista", "Tipo_Est", "Pendiente", "Curvatura", "Peralte", "Provincia", "Dia_Semana", "Carretera", "Anchura_Calzada", "Arcen", "Barrera_Seguridad", "Paneles_Direccionales", "Captafaros", "Otras_Circunstancias", "Aceras", "Alcohol_Drogas", "Estado_Condicion_Senalizacion", "Fuera_o_Interseccion", "Hora", "Hm", "Interseccion_Acondicionamiento", "Tipo_Via")

# Variables eliminadas según nearZeroVar:
# c("Numero_Accidente", "Cansancio_Sueno", "Enfermedad", "Estado_Condicion_Via", "Mal_Estado_Vehiculo", "Averia_Mecanica", "Meteorologia_Adversa", "Irrupcion_Animal", "Circular_Sentido_Contrario", "Sin_Opinion_Definida")

select_data <- function(df) {
    df <- df[,-match(c("Arboles_Metros_Calzada", "Colision_Vehiculo_Obstaculo_1", "Colision_Vehiculo_Obstaculo_2", "Atropello_1", "Atropello_2", "Vuelco_1", "Vuelco_2", "Salida_Sin_Colision", "Otro", "Visibilidad_Restringida_por", "Colision_Vehiculos_Marcha", "Salida_Con_Colision", "Lado_Salida", "Dia", "Dia_Semana", "Arcen_Pavimentado", "Circulacion", "Circulacion_Medidas_Especiales", "Inexperiencia_Conductor", "Tramo_Obras", "Otro_Factor", "Arboles", "Curvatura", "Peralte", "GPS_x", "GPS_y", "GPS_z", "IMD", "Zona", "Marcas_Viales", "Distraccion", "Hitos_Arista", "Tipo_Est", "Pendiente", "Curvatura", "Peralte", "Provincia", "Dia_Semana", "Carretera", "Anchura_Calzada", "Arcen", "Barrera_Seguridad", "Paneles_Direccionales", "Captafaros", "Otras_Circunstancias", "Aceras", "Alcohol_Drogas", "Estado_Condicion_Senalizacion", "Fuera_o_Interseccion", "Hora", "Hm", "Interseccion_Acondicionamiento", "Tipo_Via", "Numero_Accidente", "Cansancio_Sueno", "Enfermedad", "Estado_Condicion_Via", "Mal_Estado_Vehiculo", "Averia_Mecanica", "Meteorologia_Adversa", "Irrupcion_Animal", "Circular_Sentido_Contrario", "Sin_Opinion_Definida"),colnames(df))]
}

df.train <- select_data(df.train)
df.test <- select_data(df.test)
```

# Creación y partición de datos en train y test

```{r}
library(caret)

# Preparación de df.train eliminando variables y NAs
df.train <- df.train %>% select(-Id, -Timestamp, -N_Leves, -N_Graves, -N_Muertos)
df.train <- df.train %>% na.omit()

df.train.Part <- df.train
```

# Partición de los datos

```{r}
set.seed(96)
data.partition <- createDataPartition(df.train.Part$Gravedad == 'Si', 0.70)
training <- df.train[data.partition$Resample1,]
testing <- df.train[-data.partition$Resample1,]

# training %>% group_by(Gravedad) %>%
#   summarise(count = n()) %>%
#   mutate(percent = count/sum(count)*100)

# Total de casos -> 2482 (si) + 2083 (no) = 4565
# Queremos que los SI correspondan a un 73% de la muestra -> Los NO deberían ser 918 casos
# Queremos que los SI correspondan a un 70% de la muestra -> Los NO deberían ser 1064 casos
# Queremos que los SI correspondan a un 65% de la muestra -> Los NO deberían ser 1336 casos

training.yes <- training %>% filter(Gravedad == 'Si')
training.no <- training %>% filter(Gravedad == 'No')

set.seed(97)
indices_train = sample(rownames(training.no),1064)
training.no.reduced <- training.no[indices_train,]

training <- rbind(training.yes, training.no.reduced)

# length(training.yes$Gravedad)
# length(training.no$Gravedad)
# length(training.no.reduced$Gravedad)
# length(training.Part$Gravedad)

training %>% group_by(Gravedad) %>%
  summarise(count = n()) %>%
  mutate(percent = count/sum(count)*100)
```


# Creación y partición de datos en train y test

```{r}
# No existen grandes correlaciones después de haber limpiado las variables...
# findCorrelation(x = cor(df.train[sapply(df.train,is.numeric)]), names = TRUE)
# corrplot(cor(x = df.train[sapply(df.train,is.numeric)]), diag = FALSE)

# Preparación de df.train eliminando variables y NAs
df.train <- df.train %>% select(-Id, -Timestamp, -N_Leves, -N_Graves, -N_Muertos)
df.train <- df.train %>% na.omit()

df.train.Part <- df.train
```

# Partición de los datos

```{r}
set.seed(96)
data.partition <- createDataPartition(df.train.Part$Gravedad == 1, p = 0.70)
training <- df.train[data.partition$Resample1,]
testing <- df.train[-data.partition$Resample1,]

training %>% group_by(Gravedad) %>%
    summarise(count = n()) %>%
    mutate(percent = count/sum(count))

# Total de casos -> 3475 (si) + 2917 (no) = 6392
# Queremos que los SI correspondan a un 73% de la muestra -> Los NO deberían ser 1285 casos
# Queremos que los SI correspondan a un 70% de la muestra -> Los NO deberían ser 1489 casos
# Queremos que los SI correspondan a un 65% de la muestra -> Los NO deberían ser 1871 casos

# Queremos que los NO correspondan a un 27% de la muestra -> Los SI deberían ser 7887 casos (incrementar en 4412)
# Queremos que los NO correspondan a un 30% de la muestra -> Los SI deberían ser 6806 casos (incrementar en 3331)
# Queremos que los NO correspondan a un 35% de la muestra -> Los SI deberían ser 5417 casos (incrementar en 1942)
# Queremos que los NO correspondan a un 40% de la muestra -> Los SI deberían ser 4375 casos (incrementar en 1000)

training.yes <- training %>% filter(Gravedad == 1)
training.no <- training %>% filter(Gravedad == 0)

set.seed(97)
# Down-sampling
# indices_train = sample(rownames(training.no), 1336)
# training.no.reduced <- training.no[indices_train,]
# training <- rbind(training.yes, training.no.reduced)

# SMOTE
# perc.under por defecto añade 2 veces el número de casos que se añaden a perc.over, es decir, si AÑADIMOS 1,18 casos por caso a la clase minoritaria, a la mayoritaria se le añaden 2*1.18. En total quedan: clase minoritaria=clase minoritaria *2 // clase mayoritaria = clase mayoritaria*(2*1.18+1) 

# Training para modelo de NEGATIVOS
training_neg <- SMOTE(form = Gravedad ~ ., data = training, perc.over = 218, perc.under = 100)

# Training para modelo de POSITIVOS
training_pos <- SMOTE(form = Gravedad ~ ., data = training, perc.over = 100, perc.under = 300)
# indices_train = sample(rownames(training.yes), 1942, replace = TRUE)
# training.yes.amplified <- training.yes[indices_train,]
# training.yes <- rbind(training.yes, training.yes.amplified)
# training <- rbind(training.yes, training.no)

training %>% group_by(Gravedad) %>%
  summarise(count = n()) %>%
  mutate(percent = count/sum(count)*100)

training_pos %>% group_by(Gravedad) %>%
  summarise(count = n()) %>%
  mutate(percent = count/sum(count)*100)
```

# Creación de modelo

```{r}
# Selección número de cores
registerDoMC(cores = 8)

# Parámetros y generación de modelos
# train_control <- trainControl(method="repeatedcv", number=10, repeats = 1, allowParallel = TRUE, sampling = 'smote')
train_control <- trainControl(method="repeatedcv", number=10, repeats = 1, allowParallel = TRUE)

# grid_nnet<- expand.grid(size =c(seq(10,30,3)),decay = c(seq(0.2,4,0.3),))
# model_nnet <- train(Gravedad ~ ., data=training, trControl=train_control, method="nnet", importance=T, preProcess=c('scale', 'center'), na.action = na.omit, tuneGrid = grid_nnet)


grid_parRF <- expand.grid(mtry = seq(5,20,3))
model_parRF <- train(Gravedad ~ ., data=training, trControl=train_control, method="parRF", importance=T, preProcess=c('scale', 'center'), ntree=500, na.action = na.omit, tuneGrid = grid_parRF)
model_parRF

grid_ranger <- expand.grid(mtry = seq(5,20,3))
model_ranger <- train(Gravedad ~ ., data=training, trControl=train_control,method="ranger", importance=T, preProcess=c('scale', 'center'), na.action = na.omit, tuneGrid = grid_ranger)
model_ranger
# grid_RRF <- expand.grid(mtry = c(seq(5,20,3)), coefReg = , coefImp = )
# model_RRF <- train(Gravedad ~ .,data=training,trControl=train_control,method="RRF", importance=T, preProcess=c('scale', 'center'),na.action = na.omit)


grid_adaboost <- expand.grid(nIter = seq(600,1000,200), method = "ada")
model_adaboost <- train(Gravedad ~ ., data=training, trControl=train_control, method="adaboost", importance=T, preProcess=c('scale', 'center'), tuneGrid = grid_adaboost, na.action = na.omit)
model_adaboost

# model_AdaBoost.M1 <- train(Gravedad ~ .,data=training,trControl=train_control,method="AdaBoost.M1", importance=T, preProcess=c('scale', 'center'),weight=0.5, na.action = na.omit)


grid_SVMPoly <- expand.grid(C=seq(0.5,5,0.5),degree=seq(1,6),scale=seq(0.01,0.3,0.03))
model_Poly <- train(Gravedad ~ ., data=training, trControl=train_control, method="svmPoly", importance=T, preProcess=c('scale', 'center'), tuneGrid = grid_SVMPoly, na.action = na.omit)
model_Poly

grid_SVMRadial <- expand.grid(sigma=seq(0.1,0.5,0.03),C=seq(0.5,5,0.5))
model_Radial <- train(Gravedad ~ ., data=training, trControl=train_control, method="svmRadial", importance=T, preProcess=c('scale', 'center'), tuneGrid = grid_SVMRadial, na.action = na.omit)
model_Radial

# model_svmLinearWeights2 <- train(Gravedad ~ ., data=training, trControl=train_control, method="svmLinearWeights2", importance=T, preProcess=c('scale', 'center'), na.action = na.omit)
# model_svmLinearWeights <- train(Gravedad ~ .,data=training,trControl=train_control,method="svmLinearWeights", importance=T, preProcess=c('scale', 'center'),weight=0,na.action = na.omit)

grid_LogitBoost <- expand.grid(niter = seq(600,1000,200))
model_LogitBoost <- train(Gravedad ~ .,data=training,trControl=train_control,method="LogitBoost", importance=T, preProcess=c('scale', 'center'), tuneGrid = grid_LogitBoost, na.action = na.omit)
model_LogitBoost

# model_LogitBoost <- train(Gravedad ~ .,data=training,trControl=train_control,method="LogitBoost", importance=T, preProcess=c('scale', 'center'),weight=0,na.action = na.omit)
# model_deepboost <- train(Gravedad ~ .,data=training,trControl=train_control,method="deepboost", importance=T, preProcess=c('scale', 'center'),weight=0,na.action = na.omit)
# model_blackboost <- train(Gravedad ~ .,data=training,trControl=train_control,method="blackboost", importance=T, preProcess=c('scale', 'center'),weight=0,na.action = na.omit)

# model$finalModel
# 
# modelLookup('ada') # Falla por NA
# modelLookup('pda') # Falla por NA
# modelLookup('pda2') # Falla por NA
# modelLookup('PenalizedLDA') # Falla por NA
# modelLookup('plr') # Falla por NA
# modelLookup('multinom') # Falla por NA
# modelLookup('ordinalNet') # Falla por NA
# modelLookup('svmLinearWeights2')
# modelLookup('svmLinearWeights')
# modelLookup('RRF')
# modelLookup('LogitBoost')
# modelLookup('deepboost')

# summary(model)
# confusionMatrix(predict(model, testing), testing$Gravedad, positive="1")
# confusionMatrix(predict(model_1, testing), testing$Gravedad, positive="1")
# confusionMatrix(predict(model_0.5, testing), testing$Gravedad, positive="1")
# confusionMatrix(predict(model_0, testing), testing$Gravedad, positive="1")
```

# Predicción de datos de test

```{r}

test_model <- function(model) {
    print(confusionMatrix(predict(model, testing), testing$Gravedad, positive="1"))
    
    df.result <- data.frame(Id = 1:200, Prediction = predict(model, df.test))
    
    print(
    df.result %>% group_by(Prediction) %>%
    summarise(count = n()) %>%
    mutate(percent = count/sum(count)*100)
    )
}

test_model(model_nnet)

test_model(model_parRF)
test_model(model_ranger)
test_model(model_RRF)

test_model(model_adaboost)
test_model(model_AdaBoost.M1)

test_model(model_svmLinearWeights2)
test_model(model_svmLinearWeights)

test_model(model_LogitBoost)
test_model(model_deepboost)
test_model(model_blackboost)

# file <- format(Sys.time(), "results/%Y_%m_%d_%H_%M_results.csv")
# write.csv(df.result, file = file, row.names = FALSE)
```
